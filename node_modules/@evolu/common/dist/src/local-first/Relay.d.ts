import { ConsoleConfig, ConsoleDep } from "../Console.js";
import { TimingSafeEqualDep } from "../Crypto.js";
import { LazyValue } from "../Function.js";
import { Result } from "../Result.js";
import { SqliteDep, SqliteError } from "../Sqlite.js";
import { MaybeAsync } from "../Task.js";
import { SimpleName } from "../Type.js";
import { OwnerId } from "./Owner.js";
import { ProtocolInvalidDataError } from "./Protocol.js";
import { CreateBaseSqliteStorageConfig, SqliteStorageDeps, Storage, StorageConfig } from "./Storage.js";
export interface RelayConfig extends ConsoleConfig, StorageConfig {
    /**
     * The relay name.
     *
     * Implementations can use this for identification purposes (e.g., database
     * file name, logging).
     */
    readonly name?: SimpleName;
    /**
     * Optional callback to check if an {@link OwnerId} is allowed to access the
     * relay. If this callback is not provided, all owners are allowed.
     *
     * The callback receives the {@link OwnerId} and returns a {@link MaybeAsync}
     * boolean: `true` to allow access, or `false` to deny.
     *
     * The callback can be synchronous (for SQLite or in-memory checks) or
     * asynchronous (for calling remote APIs).
     *
     * The callback returns a boolean rather than an error type because error
     * handling and logging are the responsibility of the callback
     * implementation.
     *
     * OwnerId is used rather than short-lived tokens because this only controls
     * relay access, not write permissions. Since all data is encrypted on the
     * relay, OwnerId exposure is safe.
     *
     * Owners specify which relays to connect to via {@link OwnerTransport}. In
     * WebSocket-based implementations, this check occurs before accepting the
     * connection, with the OwnerId typically extracted from the URL Path (e.g.,
     * `ws://localhost:4000/<ownerId>`). The relay requires the URL to be in the
     * correct format for OwnerId extraction.
     *
     * ### Example
     *
     * ```ts
     * // Client
     * const transport = createOwnerWebSocketTransport({
     *   url: "wss://relay.evolu.dev",
     *   ownerId: owner.id,
     * });
     *
     * const evolu = createEvolu(deps)(Schema, {
     *   transports: [transport],
     * });
     *
     *
     * // Relay
     * isOwnerAllowed: (ownerId) =>
     *   Promise.resolve(ownerId === "6jy_2F4RT5qqeLgJ14_dnQ"),
     * ```
     */
    readonly isOwnerAllowed?: (ownerId: OwnerId) => MaybeAsync<boolean>;
}
/**
 * A completely interchangeable server for syncing and backing up encrypted data
 * between Evolu clients.
 *
 * Unlike traditional servers, relays are blind by designâ€”they transmit
 * encrypted data without understanding its shape or meaning. This enables true
 * decentralization and infinite horizontal scalability with minimal
 * infrastructure.
 */
export interface Relay extends Disposable {
}
export declare const createRelaySqliteStorage: (deps: SqliteStorageDeps & TimingSafeEqualDep) => (config: CreateBaseSqliteStorageConfig) => Storage;
export declare const createRelayStorageTables: (deps: SqliteDep) => Result<void, SqliteError>;
export interface RelayLogger {
    readonly started: (enableLogging: boolean, port: number) => void;
    readonly storageError: (error: unknown) => void;
    readonly upgradeSocketError: (error: Error) => void;
    readonly invalidOrMissingOwnerIdInUrl: (url: string | undefined) => void;
    readonly unauthorizedOwner: (ownerId: OwnerId) => void;
    readonly connectionEstablished: (totalConnectionCount: number) => void;
    readonly connectionWebSocketError: (error: Error) => void;
    readonly relayOptionSubscribe: (ownerId: OwnerId, getSubscriberCount: LazyValue<number>) => void;
    readonly relayOptionUnsubscribe: (ownerId: OwnerId, getSubscriberCount: LazyValue<number>) => void;
    readonly relayOptionBroadcast: (ownerId: OwnerId, broadcastCount: number, subscriberCount: number) => void;
    readonly messageLength: (messageLength: number) => void;
    readonly applyProtocolMessageAsRelayError: (error: ProtocolInvalidDataError) => void;
    readonly responseLength: (responseLength: number) => void;
    readonly applyProtocolMessageAsRelayUnknownError: (error: unknown) => void;
    readonly connectionClosed: (totalConnectionCount: number) => void;
    readonly shuttingDown: () => void;
    readonly webSocketServerDisposed: () => void;
    readonly httpServerDisposed: () => void;
}
export declare const createRelayLogger: (deps: ConsoleDep) => RelayLogger;
//# sourceMappingURL=Relay.d.ts.map