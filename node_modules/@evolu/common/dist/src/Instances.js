/** Creates an {@link Instances}. */
export const createInstances = () => {
    const instances = new Map();
    return {
        ensure: (key, create, onCacheHit) => {
            let instance = instances.get(key);
            if (instance == null) {
                instance = create();
                instances.set(key, instance);
            }
            else if (onCacheHit) {
                onCacheHit(instance);
            }
            return instance;
        },
        get: (key) => instances.get(key) ?? null,
        has: (key) => instances.has(key),
        delete: (key) => {
            const instance = instances.get(key);
            if (instance == null)
                return false;
            instances.delete(key);
            instance[Symbol.dispose]();
            return true;
        },
        [Symbol.dispose]: () => {
            const errors = [];
            for (const instance of instances.values()) {
                try {
                    instance[Symbol.dispose]();
                }
                catch (error) {
                    errors.push(error);
                }
            }
            instances.clear();
            if (errors.length === 1)
                throw errors[0];
            if (errors.length > 1) {
                throw new AggregateError(errors, "Multiple disposal errors occurred");
            }
        },
    };
};
